---
title: "canu"
author: "Roberto Canu"
format:
  html:
    code-fold: false
    message: false
    warning: false
editor: visual
---

```{r}
here::i_am("grades.Rproj")
library(here)
library(ggplot2)
library(dplyr)
library(tidyr)
library(vroom)
library(readr)
library(lubridate)
```
You can find the GitHub repository here:  
[GitHub: robertocanu/grades](https://github.com/robertocanu/grades)



# INTRODUCTION

## Study organisation

### Question 1

```{r}
courses <- vroom(here("datafold", "courses.csv"))
```
## Question 2 

```{r}
courses |>
  arrange(course) |>
  knitr::kable()
```

## 1.2 Students 

### Question 3

```{r}
students <- read_delim(
  here("datafold", "students.csv"),
  col_types = cols(
    birth_date = col_date(),
    group = col_factor(),
    id = col_integer()
  )
)
```

The `birth_date` column of the `students` data frame is of class *`r class(students$birth_date)`*.

## 1.3 Grades 

### Question 4 
```{r}
grades <- read_delim(
  here("datafold", "grades.csv"),
  delim = ":",
  na = "_"
)
```
# Student Population analysis

### Question 5

```{r}
students |>
  summarise(n = n(), .by = group) |>
  ggplot(aes(x = as.integer(as.character(group)), y = n)) +
  geom_col() +
  labs(x = "Group", y = "Count")
```

### Question 6 
```{r}
students |>
  summarise(n = n(), .by = c(group, sex)) |>
  ggplot(aes(x = as.integer(as.character(group)), y = n, fill = sex)) +
  geom_col(position="fill") +
  labs(x = "Group", y = "Gender Balance")

```


### Question 7 
```{r}
students <- students |>
  mutate(age = time_length(today() - birth_date, unit = "year")) 

students |>
  ggplot(aes(x = age)) +
  geom_density(bw = "sj") +
  geom_rug(alpha = 0.1) +
  labs(x = "Age", y = "Density")
```

### Question 8 
```{r}
students |>
  summarise(median_age = round(median(age)), .by = group) |>
  arrange(as.integer(as.character(group))) |> 
  knitr::kable()
```

### Question 9 
```{r}
students |>
  slice_max(age, by = group) |>
  select(id, sex, age, group) |>
  arrange(desc(age)) |>
  knitr::kable()
```

# Simple grade analysis

### Question 10 
```{r}
ngrades <- grades |> 
  filter(!is.na(grade)) |> nrow()
```
The data set contains **`r ngrades`** grades.


### Question 11
```{r}
grades_courses <-
  left_join(grades, courses,
    by = join_by(course_id))

complete <- left_join(grades_courses, students,
                      by = join_by(id))

complete |>
  filter(course == "Art and Symbolism",
         !is.na(grade)) |>
  summarise(average_grade = mean(grade), .by = group) |>
  ggplot(aes(x = as.integer(as.character(group)), y = average_grade)) +
  geom_col(fill="darkblue") +
  labs(x = "Group",
       y = "Av. grade in Art and Symbolism")

```

### Question 12 
```{r}
complete |>
  filter(!is.na(grade)) |>
  ggplot(aes(x = grade, fill = factor(semester))) + geom_density(bw = 1, alpha = 0.3) +
  labs(x = "Grade", y = "Density", fill = "Semester")
```

# Attendance analysis

### Question 13
```{r}
grades_per_student <- complete |>
  filter(!is.na(grade)) |>
  summarise(n_grades = n(), .by = c(id, group, sex)) |>
  arrange(as.integer(as.character(id))) |>
  rename(`Student ID` = id, Group = group, Sex = sex,
    `Number of grades` = n_grades)

grades_per_student |>
  summarise(
    Minimum = min(`Number of grades`),
    Maximum = max(`Number of grades`),
    Average = mean(`Number of grades`),
    Median  = median(`Number of grades`)) |>
  tidyr::pivot_longer(everything(), names_to = "Statistic") |>
  knitr::kable()

```


### Question 14
```{r}
grades_per_student |>
  ggplot(aes(x = `Number of grades`, fill = factor(Sex))) + 
  geom_density(bw = 1, alpha = 0.3) +
  labs(x = "Number of grades", y = "Density", fill = "Sex")
```

### Question 15
```{r}
grades_astronomy_per_student <- complete |>
  filter(
    course == "Astronomy and Celestial Navigation",
    !is.na(grade)) |>
  summarise(n_grades = n(), .by = c(id, group, sex)) |>
  arrange(as.integer(as.character(id))) |>
  rename(`Student ID` = id, Group = group, Sex = sex,
         `Number of grades in Astronomy and Celestial Navigation` = n_grades)

grades_astronomy_per_student |>
  slice_head(n = 10) |>
  knitr::kable()
```

### Question 16 
```{r}
grades_astronomy_per_student |>
  summarise(n_students = n(), .by = `Number of grades in Astronomy and Celestial Navigation`) |>
  ggplot(aes(
    x = `Number of grades in Astronomy and Celestial Navigation`,
    y = n_students)) +
  geom_col(fill='darkblue') +
  labs(x = "Number of grades", y = "Number of students")
```

### Question 17 
```{r}
grades_astronomy_per_student |>
  mutate(Group = factor(Group,
    levels = sort(unique(as.integer(as.character(Group)))))) |>
  ggplot(aes(x = Group,
    y = `Number of grades in Astronomy and Celestial Navigation`)) +
  geom_boxplot() +
  labs(x = "Group", y = "Number of grades in Astronomy and Celestial Navigation")
```

### Question 18 

```{r}
grades_astronomy_per_student |>
  mutate(Group = factor(Group,
    levels = sort(unique(as.integer(as.character(Group)))))) |>
  ggplot(aes(x = Group,
    y = `Number of grades in Astronomy and Celestial Navigation`)) +
  geom_boxplot() +
  facet_wrap(vars(Sex), ncol = 1) +
  labs(x = "Group", y = "Number of Grades in Astronomy and C. N.")
```

# Grade analysis

### Question 19
```{r}
avg_grades_per_student <-
  complete |>
  filter(!is.na(grade)) |>
  summarise(
    mean_grade = mean(grade),
    .by = c(id, group, course))

pivoted_avg_grades_per_student <- avg_grades_per_student |>
  tidyr::pivot_wider(
    names_from  = course,
    values_from = mean_grade) |>
  arrange(as.integer(as.character(id)))

pivoted_avg_grades_per_student |>
  slice_head(n = 5) |>
  knitr::kable()
```


### Question 20
```{r}
pivoted_avg_grades_per_student |>
  ggplot(aes(x = `Astronomy and Celestial Navigation`,
    y = `Art and Symbolism`)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) + 
  labs(x = "Average grade in Astronomy and Celestial Navigation",
    y = "Average grade in Art and Symbolism")
```

### Question 21
```{r}
pivoted_avg_grades_per_student |>
  summarise(
    correlation = cor(
      `Astronomy and Celestial Navigation`,
      `Tribal Lore and Traditions`),
    .by = group) |>
  arrange(as.integer(as.character(group))) |>
  slice_head(n = 5) |>
  knitr::kable()
```

### Question 22
```{r}
best_group <-pivoted_avg_grades_per_student |>
  summarise(correlation = cor(
      `Astronomy and Celestial Navigation`,
      `Tribal Lore and Traditions`),
    .by = group) |>
  slice_max(abs(correlation)) |>
  pull(group)
```

The group where the grades in `Tribal Lore and Traditions` and in `Astronomy and Celestial Navigation` are more correlated is **`r best_group`**.

```{r}
pivoted_avg_grades_per_student |>
  filter(group == best_group) |>
  ggplot(aes(
    x = `Tribal Lore and Traditions`,
    y = `Astronomy and Celestial Navigation`)) +
  geom_point(alpha = 0.5) +
  geom_smooth(method = "lm", se = FALSE) +
  labs(
    x = "Average grade in Tribal Lore and Traditions",
    y = "Average grade in Astronomy and Celestial Navigation"
  )
```

### Question 23
```{r}
final_grades <-
  left_join(
    pivoted_avg_grades_per_student,
    students |> select(id, sex),
    by = join_by(id)
  ) |>
  mutate(
    final_grade = (
      `Art and Symbolism` +
      `Astronomy and Celestial Navigation` +
      `Environmental Stewardship` +
      `Herbalism and Medicine` +
      `Hunting and Gathering Skills` +
      `Language and Linguistics` +
      `Shamanism and Spiritual Practices` +
      `Social Organization and Governance` +
      `Tribal Lore and Traditions` +
      `Warfare and Diplomacy`
    ) / 10
  ) |>
  select(id, group, sex, final_grade) |>
  arrange(desc(final_grade))

final_grades |>
  slice_head(n = 5) |>
  knitr::kable()
```



